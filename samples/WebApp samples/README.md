# TotalAPI client Web application sample

Пример работающего приложения - [http://demo.totalapi.io](http://demo.totalapi.io)

Описание
--------
Это пример примитивного приложения отображающего пердвижение транспортных средств, связанных с известными устройствами слежения на карте. 
Ознакомьтесь предварительно с примерами использования TotalApi SDK, в папке [SDK samples](https://github.com/TotalApi/SDK-dNet/tree/master/samples/SDK%20samples), например, [DemoChat](https://github.com/TotalApi/SDK-dNet/tree/master/samples/SDK%20samples/DemoChat).


Начальные шаги
-------------
1. Создадим обычное MVC Web-приложение.
2. Добавим необходимые сборки SDK TotalApi, описанные [здесь](https://github.com/TotalApi/SDK-dNet#3-include-the-sdk-modules).

Настройка `web.config`
----------------------
Укажем протокол и адрес подключения к серверу **TotalApi**.
В данном примере будем использовать уже готовое демонстрационное приложение с `ApiKey` **"DemoApiKey"**. 
```xml
    <appSettings>
        <add key="serverHost" value="http://services.totalapi.io:1202" />
        <add key="apiKey" value="DemoApiKey" />
    </appSettings>
```

Инициализация SDK TotalApi
--------------------------
Инициализацию необходимо сделать как можно раньше. Идеальное место для этого класс `Startup`, описанный в одноимённом модуле:
```C#
[assembly: OwinStartup(typeof(Startup))]

namespace WebApp
{
    public class Startup
    {
        public void Configuration(IAppBuilder app)
        {
            // Инициализируем MEF.
            TotalApiBootstrapper.Create();

            // Configure SignalR
            app.MapSignalR(new HubConfiguration { EnableDetailedErrors = true });

            // подписка на события от сервера передаваемые через SignalR хаб.
            CoreApi.EventManager.Subscribe(MessagingHub.Instance);
        }
    }
}
```
При создании, бутстраппер загружает все необходимые сборки, выполняет настройку MEF-композиции, необходимой для работы приложения. Связывается с сервером TotalApi и получает необходимую информацию о подсистемах программного комплекса. 
Далее мы инициализируем **signalR-Hub** (используется код, взятый из [примера](http://www.asp.net/signalr/overview/getting-started/tutorial-getting-started-with-signalr) **MSDN** и подписываем экземляр хаба на события **TotalApi**. Хаб будет принимать события и ретранслировать их клиентам-браузерам.

Краткое описание
----------------
Код написан максимально просто без особых наворотов и проверок. Базы данных как таковой нет - данные храняться и изменяются в памяти. Через определённое время БД "восстанавливается" к первоначальному состоянию.
Модель данных такова: `Транспорт` сиволизирует транспортные средства, перемещения которых мы отслеживаем. Это сущность нашего приложения о которой **TotalApi** ничего не знает. 
Каждый объект `Транспорт` связывается с сущностью `Устройством слежения (Device)` которая является представлением физического устройства отправляющего координаты о своём местоположении. Это уже та сущность про которую знает `TotalApi` (точнее её подсистема для работы с телематическими данными `Metrix`).
`Устройство слежения` может идентифицироваться в подсистеме `Metrix` одним из пяти способов (возможно использование одновременно нескольких способов):
* `DbId`: по *внутреннему идентификатору* системы `Metrix`, полученному при регистрации устройства
* `PhoneNumber`: по *телефонному номеру* карточки, используемой для передачи информации на сервер
* `OwnId`: по *серийному номеру*, выданному производителем устройства
* `Mac`: по *MAC-адресу* сетевого интерфейса, зашитого в устройство
* `IMEI`: по *IMEI* радиомодуля, зашитого в устройство

При создании `транспортного средства` его необходимо связать с одним из `устройств слежения`, указав один их возможных идентификаторов.

В TotalApi-приложении, используемом в данном примере, зарегистрировано восемь устройств слежения, движения которых эмулируются в реальном времени, со следующими идентификаторами:

1. `PhoneNumber`: "+822542119082"
2. `PhoneNumber`: "+704337715079"
3. `OwnId`: "05b5607d-a0d1-4a09-8c27-5e908c64c32f"
4. `OwnId`: "7a80275e-a43e-4f84-b20c-572b16503e08"
5. `PhoneNumber`: "+555-0001", `OwnId`: "1111"
6. `PhoneNumber`: "+555-0002", `OwnId`: "2222"
7. `PhoneNumber`: "+555-0003", `OwnId`: "3333"
8. `PhoneNumber`: "+555-0004", `OwnId`: "4444"
 
Изначально уже создано четыре транспортных средства, которые связаны с четырьмя первыми устройствами слежения.
Вы можете добавить ещё до четырёх дополнительных транспортных средств, связав их с одним из оствашихся устройств слежения по телефонному или серийному номеру. 

Пример работающего приложения, приближённого к реальному, на котором можно увидеть все маршрутки Днепра - [http://mdcdemo.totalapi.io](http://mdcdemo.totalapi.io).
